CREATE OR REPLACE PROCEDURE SFC2EDI_DELIVER IS
BEGIN
-- 2006/11/23: Steven Chien


--*****************************************************
   --**update record_status **
   --2007/3/10 key_peng
   UPDATE B2B.PT_HEADER SET RECORD_STATUS='0' WHERE RECORD_STATUS='1' AND MOVE_FLAG = 'Y';
   commit;

   UPDATE B2B.PT_ITEMS SET RECORD_STATUS='0' WHERE RECORD_STATUS='1' AND MOVE_FLAG = 'Y';
   commit;

   UPDATE B2B.PT_SERIAL SET RECORD_STATUS='0' WHERE RECORD_STATUS='1' AND  MOVE_FLAG = 'Y';
   commit;

   UPDATE B2B.PT_REFERENCE SET RECORD_STATUS='0' WHERE RECORD_STATUS='1' AND  MOVE_FLAG = 'Y';
   commit;

--*****************************************************

-- *** move to b2b.HT_PT_HEADER ***
   INSERT INTO b2b.HT_PT_HEADER
          SELECT * FROM b2b.PT_HEADER WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
          
   DELETE FROM b2b.PT_HEADER WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
   COMMIT;
-- *** move to b2b.HT_PT_ITEMS ***
   INSERT INTO b2b.HT_PT_ITEMS
          SELECT * FROM b2b.PT_ITEMS WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
          
   DELETE FROM b2b.PT_ITEMS WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
   COMMIT;
-- *** move to b2b.HT_PT_SERIAL ***
   INSERT INTO b2b.HT_PT_SERIAL
          SELECT * FROM b2b.PT_SERIAL WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
          
   DELETE FROM b2b.PT_SERIAL WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
   COMMIT;
-- *** move to b2b.HT_PT_REFERENCE ***
   INSERT INTO b2b.HT_PT_REFERENCE
          SELECT * FROM b2b.PT_REFERENCE WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
          
   DELETE FROM b2b.PT_REFERENCE WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS = '0';
   COMMIT;
-- *****************************************

-- *** copy to b2b.PT_HEADER@SFC2EDI ***
   UPDATE b2b.PT_HEADER SET MOVE_FLAG = 'Y' WHERE RECORD_STATUS IS NULL;

   INSERT INTO b2b.PT_HEADER@SFC2EDI 
         (DOC_ID, SENDER_ID, RECEIVER_ID, INVENTORY_BATCH_ID, SYSTEM_DATE, FINISH_DATE, SEQ_ID,INVENTORY_LOCATION_NAME)
         (SELECT DOC_ID, SENDER_ID, RECEIVER_ID, INVENTORY_BATCH_ID, SYSTEM_DATE, FINISH_DATE, SEQ_ID,INVENTORY_LOCATION_NAME
            FROM b2b.PT_HEADER WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL);

   UPDATE b2b.PT_HEADER SET RECORD_STATUS = '1' WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL;

-- *** copy to b2b.PT_ITEMS@SFC2EDI ***
   UPDATE b2b.PT_ITEMS SET MOVE_FLAG = 'Y' WHERE RECORD_STATUS IS NULL;

   INSERT INTO b2b.PT_ITEMS@SFC2EDI 
         (DOC_ID, WORK_ORDER_NUMBER, TRANSFER_QUANTITY,ROW_ITEM_NUMBER, FG_ITEM_NUMBER, SEQ_ID,TRANSFER_TYPE_CODE,
		 CUST_RAW_PART_NUMBER, CUST_KIT_PART_NUMBER, FROM_MANUFACTURING_LOCATION, TO_MANUFACTURING_LOCATION)
         (SELECT DOC_ID, WORK_ORDER_NUMBER, TRANSFER_QUANTITY,ROW_ITEM_NUMBER , FG_ITEM_NUMBER, SEQ_ID,TRANSFER_TYPE_CODE,
		 CUST_RAW_PART_NUMBER, CUST_KIT_PART_NUMBER, FROM_MANUFACTURING_LOCATION, TO_MANUFACTURING_LOCATION
            FROM b2b.PT_ITEMS WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL);

   UPDATE b2b.PT_ITEMS SET RECORD_STATUS = '1' WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL;

-- *** copy to b2b.PT_SERIAL@SFC2EDI ***
   UPDATE b2b.PT_SERIAL SET MOVE_FLAG = 'Y' WHERE RECORD_STATUS IS NULL;

   INSERT INTO b2b.PT_SERIAL@SFC2EDI 
         (DOC_ID, WORK_ORDER_NUMBER, SERIAL_NUMBER, FIRMWARE_VERSION, SEQ_ID, ORIGIN_COUNTRY, ASSEMBLY_QUANTITY)
         (SELECT DOC_ID, WORK_ORDER_NUMBER, SERIAL_NUMBER, FIRMWARE_VERSION, SEQ_ID, ORIGIN_COUNTRY, ASSEMBLY_QUANTITY
            FROM b2b.PT_SERIAL WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL);

   UPDATE b2b.PT_SERIAL SET RECORD_STATUS = '1' WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL;

-- *** copy to b2b.PT_REFERENCE@SFC2EDI ***
   UPDATE b2b.PT_REFERENCE SET MOVE_FLAG = 'Y' WHERE RECORD_STATUS IS NULL;

   INSERT INTO b2b.PT_REFERENCE@SFC2EDI 
         (DOC_ID, WORK_ORDER_NUMBER, SERIAL_NUMBER, DRIVE_SERIAL_NUMBER, DRIVE_POSITION, DRIVE_FIRMWARE_VERSION, SEQ_ID)
         (SELECT DOC_ID, WORK_ORDER_NUMBER, SERIAL_NUMBER, DRIVE_SERIAL_NUMBER, DRIVE_POSITION, DRIVE_FIRMWARE_VERSION, SEQ_ID
            FROM b2b.PT_REFERENCE WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL);

   UPDATE b2b.PT_REFERENCE SET RECORD_STATUS = '1' WHERE MOVE_FLAG = 'Y' AND RECORD_STATUS IS NULL;
-- **********************************************

   COMMIT;
EXCEPTION
   WHEN OTHERS THEN 
        ROLLBACK;
END;
/
