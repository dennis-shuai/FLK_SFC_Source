CREATE OR REPLACE PROCEDURE
                MES_MRB_SN_INPUT(TTYPE IN VARCHAR2,TPARTNO IN VARCHAR2, TWO IN VARCHAR2,
          TPALLET IN VARCHAR2,TSN IN VARCHAR2, TEMPID IN VARCHAR2, TRES OUT VARCHAR2) AS
C_ID 	VARCHAR2(25);
CCOUNT	NUMBER;
C_ITEMID VARCHAR2(25);
C_SITEMID VARCHAR2(25);
C_MOVEFLAG VARCHAR2(1);

BEGIN
--ONE WO ONLEY HAS ONE PALLET
   --CHECK SN
    SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_TO_MRB_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
      TRES :='SN DUB';
      GOTO ENDP; 
    END IF;
	
	SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_HT_TO_MRB_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
      TRES :='SN DUB';
      GOTO ENDP; 
    END IF;
	
	SELECT COUNT(*) INTO CCOUNT FROM 
	  (SELECT SERIAL_NUMBER FROM B2B.ASN_IN_SERIAL WHERE SERIAL_NUMBER=TSN
        UNION ALL
       SELECT SERIAL_NUMBER FROM B2B.HT_ASN_IN_SERIAL WHERE SERIAL_NUMBER=TSN);
	IF CCOUNT=0 THEN
      TRES :='NOT FIND HDD_SN IN ASN_IN_SERIAL TABLE';
      GOTO ENDP; 
    END IF; 
    
   --CHECK PART_NO AND ITIEM_NO
    C_ITEMID :='XX';
    SELECT NVL(OPTION7,0) INTO C_ITEMID FROM SAJET.SYS_PART WHERE PART_NO=TPARTNO;
    IF C_ITEMID='XX' OR C_ITEMID=0 THEN
        TRES:='PART_NO SET ERROR';
        GOTO ENDP; 
    END IF;
	
   select count(*) INTO CCOUNT from SAJET.MES_HT_TO_MRB_SN where work_order=TWO AND ROWNUM=1 ;
   IF CCOUNT>0 THEN 
      TRES:= TWO||' IN MES_HT_TO_MRB_SN';
	  GOTO ENDP;
   END IF;

   select count(*) INTO CCOUNT from SAJET.MES_TO_MRB_SN where work_order=TWO ;

   C_ID := 'XX';
   IF CCOUNT = 0 THEN
     SAJET.MES_PUSH_TITLE_GET_ID('MB', C_ID);  --MRB 
   END IF;
   IF CCOUNT > 0 THEN
      select MOVE_FLAG INTO C_MOVEFLAG from SAJET.MES_TO_MRB_SN where work_order=TWO AND ROWNUM=1;
	  IF C_MOVEFLAG='Y' THEN
	     --SAJET.MES_PUSH_TITLE_GET_ID('MB', C_ID);  --MRB 
		 TRES:='PALLET CLOSED';
		 GOTO ENDP;
	  ELSE 
	     C_SITEMID:='XXX'; 
	     SELECT ITEM_ID,CHECK_CODE INTO C_SITEMID, C_ID FROM  SAJET.MES_TO_MRB_SN WHERE WORK_ORDER=TWO AND  MOVE_FLAG='N' AND ROWNUM=1;      
         --CHECK PART_NO IN WO
		 IF C_ITEMID<>C_SITEMID THEN
		    TRES:='PART_NO IS DIFFERENT';
			GOTO ENDP;
		 END IF;
	  END IF;
   END IF;
   IF C_ID = 'XX' THEN
        TRES := 'TTYPE ERROR ('||TTYPE||')'; 
        GOTO ENDP;
     ELSE
        insert into SAJET.MES_TO_MRB_SN
                    (work_order,item_id,subinv, pallet_no,serial_number,create_time, to_erp, move_flag, check_code, user_id, seq_id)
             values (TWO, c_itemID,'W1B', TPALLET, TSN,SYSDATE, 'N', 'N',  C_ID, TEMPID, C_ID);
        
       COMMIT;

       TRES := 'OK';
   END IF;
<<ENDP>>
  NULL;
EXCEPTION
   WHEN OTHERS THEN
      ROLLBACK;
      TRES := 'MES_MRB_SN_INPUT ERROR';
END;
/
