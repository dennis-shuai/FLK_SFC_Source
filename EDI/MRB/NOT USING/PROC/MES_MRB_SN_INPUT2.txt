CREATE OR REPLACE PROCEDURE
         MES_MRB_SN_INPUT2(TORGID IN VARCHAR2,TSUBINV IN VARCHAR2, TLOCATOR IN VARCHAR2,
		 TTYPE IN VARCHAR2,TPARTNO IN VARCHAR2, TWO IN VARCHAR2,TPALLET IN VARCHAR2,
		 TSN IN VARCHAR2, TEMPID IN VARCHAR2, TCUSTPARTNO IN VARCHAR2, TRES OUT VARCHAR2) AS
C_ID 	VARCHAR2(25);
CCOUNT	NUMBER;
C_ITEMID VARCHAR2(25);
C_SITEMID VARCHAR2(25);
C_MOVEFLAG VARCHAR2(1);
C_ORGID  VARCHAR2(10);
C_SUBINV  SAJET.SYS_WAREHOUSE.WAREHOUSE_NAME%TYPE;
C_LOCATOR SAJET.SYS_LOCATE.LOCATE_NAME%TYPE;
BEGIN
--ONE WO ONLEY HAS ONE PALLET 
    --CHECK ORGID 
    IF (TORGID<>'85')  AND (TORGID<>'509') AND (TORGID<>'1437') THEN
	   TRES:='SELECT ORG ERR!';
	   GOTO ENDP;
	END IF;
	--CHECK STOCK 
	IF  (TSUBINV<>'W1B') and (TSUBINV<>'Q0BB/T') and (TSUBINV<>'Q0BBF/T') and (TSUBINV<>'Q02BBF/T') THEN
	   TRES:='SELECT STOCK ERR!';
	   GOTO ENDP;
	END IF;
	-- CHECK ORG AND STOCK COMPARE 
	IF TORGID='85' THEN
	  IF TSUBINV<>'W1B' THEN
	     TRES:='ORG AND STOCK IS ERROR!';
	     GOTO ENDP;
	  END IF;
	END IF;
    IF TORGID='509' THEN
	   IF TSUBINV<>'Q0BB/T' THEN
	      TRES:='ORG AND STOCK IS ERROR!';
	      GOTO ENDP;
	   END IF;
	END IF;
	IF TORGID='1437' THEN
	   IF (TSUBINV<>'Q0BBF/T') and (TSUBINV<>'Q02BBF/T')  THEN
	      TRES:='ORG AND STOCK IS ERROR!';
	      GOTO ENDP;
	   END IF;
	END IF;
	
	--check locate 
	begin
	    SELECT ORG_ID,SUBINV,LOCATOR INTO C_ORGID,C_SUBINV,C_LOCATOR  FROM SAJET.MES_TO_MRB_SN 
		WHERE WORK_ORDER=TWO AND ROWNUM=1;
		IF TORGID<>C_ORGID THEN
		    TRES:='SELECT ORG ERR!';
			GOTO ENDP;
		END IF;
		IF TSUBINV<>C_SUBINV THEN
		    TRES:='SELECT STOCK ERR!';
			GOTO ENDP;
		END IF;
		IF TLOCATOR<>C_LOCATOR THEN
		   TRES:='SELECT LOCATOR ERR!';
		   GOTO ENDP;
		END IF;
	exception
	   when others then
	     tres:='OK';
	end;
	
	
   --CHECK SN 
    SELECT COUNT(*) INTO CCOUNT FROM SAJET.G_SN_KEYPARTS WHERE ITEM_PART_SN=TSN;
	IF CCOUNT>0 THEN
	   TRES:='THE SN IS GOOD,NOT IS FAIL!';
	   GOTO ENDP;
	END IF;
   
    SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_TO_MRB_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
      TRES :='SN DUB';
      GOTO ENDP; 
    END IF;
	
	SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_HT_TO_MRB_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
      TRES :='SN DUB';
      GOTO ENDP; 
    END IF;
	
	SELECT COUNT(*) INTO CCOUNT FROM 
	  (SELECT SERIAL_NUMBER FROM B2B.ASN_IN_SERIAL WHERE SERIAL_NUMBER=TSN
        UNION ALL
       SELECT SERIAL_NUMBER FROM B2B.HT_ASN_IN_SERIAL WHERE SERIAL_NUMBER=TSN);
	IF CCOUNT=0 THEN
      TRES :='NOT FIND HDD_SN IN ASN_IN_SERIAL TABLE';
      GOTO ENDP; 
    END IF; 
    
   --CHECK PART_NO AND ITIEM_NO
    C_ITEMID :='XX';
    SELECT NVL(OPTION7,0) INTO C_ITEMID FROM SAJET.SYS_PART WHERE PART_NO=TPARTNO;
    IF C_ITEMID='XX' OR C_ITEMID=0 THEN
        TRES:='PART_NO SET ERROR';
        GOTO ENDP; 
    END IF;
	
	--CHECK CUST_PART_NO 
	SELECT COUNT(CUST_PART_NO) INTO CCOUNT FROM SAJET.SYS_PART 
	    WHERE PART_NO=TPARTNO AND CUST_PART_NO=TCUSTPARTNO AND ROWNUM=1;
	IF CCOUNT=0 THEN
	   TRES:='NOT FIND CUST_PART_NO';
	   GOTO ENDP;
	END IF;
	
   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_TO_MRB_SN WHERE work_order=TWO AND MOVE_FLAG='Y' ;
   IF CCOUNT>0 THEN 
      TRES:= TWO||' IS CLOSED(MRB_NO)';
	  GOTO ENDP;
   END IF;
	
   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_HT_TO_MRB_SN WHERE work_order=TWO AND ROWNUM=1 ;
   IF CCOUNT>0 THEN 
      TRES:= TWO||' IS CLOSED(MRB_NO)';
	  GOTO ENDP;
   END IF;

   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_TO_MRB_SN WHERE work_order=TWO ;

   C_ID := 'XX';
   IF CCOUNT = 0 THEN
     SAJET.Mes_Push_Title_Get_Id('MB', C_ID);  --MRB 
   END IF;
   IF CCOUNT > 0 THEN
      SELECT MOVE_FLAG INTO C_MOVEFLAG FROM SAJET.MES_TO_MRB_SN WHERE work_order=TWO AND ROWNUM=1;
	  IF C_MOVEFLAG='Y' THEN
	     --SAJET.MES_PUSH_TITLE_GET_ID('MB', C_ID);  --MRB 
		 TRES:=TPALLET||' IS CLOSED(PALLET)';
		 GOTO ENDP;
	  ELSE 
	     C_SITEMID:='XXX'; 
	     SELECT ITEM_ID,CHECK_CODE INTO C_SITEMID, C_ID FROM  SAJET.MES_TO_MRB_SN WHERE WORK_ORDER=TWO AND  MOVE_FLAG='N' AND ROWNUM=1;      
         --CHECK PART_NO IN WO
		 IF C_ITEMID<>C_SITEMID THEN
		    TRES:='PART_NO IS DIFFERENT';
			GOTO ENDP;
		 END IF;
	  END IF;
   END IF;
   IF C_ID = 'XX' THEN
        TRES := 'TTYPE ERROR ('||TTYPE||')'; 
        GOTO ENDP;
     ELSE
	    /*IF C_ORGID='85' THEN
             INSERT INTO SAJET.MES_TO_MRB_SN
                    (work_order,item_id,subinv, pallet_no,serial_number,create_time, to_erp, move_flag, check_code, user_id, seq_id, org_id, cust_part_no)
             VALUES (TWO, c_itemID,'W1B', TPALLET, TSN,SYSDATE, 'N', 'N',  C_ID, TEMPID, C_ID,'85', TCUSTPARTNO);
        ELSIF C_ORGID='509' THEN
		     INSERT INTO SAJET.MES_TO_MRB_SN
                    (work_order,item_id,subinv, pallet_no,serial_number,create_time, to_erp, move_flag, check_code, user_id, seq_id, org_id, cust_part_no)
             VALUES (TWO, c_itemID,'Q0BB/T', TPALLET, TSN,SYSDATE, 'N', 'N',  C_ID, TEMPID, C_ID,'509', TCUSTPARTNO); 
		ELSIF C_ORGID='1437' THEN
		     INSERT INTO SAJET.MES_TO_MRB_SN
                    (work_order,item_id,subinv, pallet_no,serial_number,create_time, to_erp, move_flag, check_code, user_id, seq_id, org_id, cust_part_no)
             VALUES (TWO, c_itemID,'Q0BBF/T', TPALLET, TSN,SYSDATE, 'N', 'N',  C_ID, TEMPID, C_ID,'1437', TCUSTPARTNO);
		END IF;
		*/
	   INSERT INTO SAJET.MES_TO_MRB_SN
                    (work_order,item_id,subinv,LOCATOR, pallet_no,serial_number,create_time, to_erp, move_flag, check_code, user_id, seq_id, org_id, cust_part_no)
             VALUES (TWO, c_itemID,TSUBINV,TLOCATOR, TPALLET, TSN,SYSDATE, 'N', 'N',  C_ID, TEMPID, C_ID,TORGID, TCUSTPARTNO);
       COMMIT;

       TRES := 'OK';
   END IF;
<<ENDP>>
  NULL;
EXCEPTION
   WHEN OTHERS THEN
      ROLLBACK;
      TRES := 'MES_MRB_SN_INPUT ERROR';
END;
/
