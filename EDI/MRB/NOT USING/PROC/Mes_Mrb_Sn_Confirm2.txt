CREATE OR REPLACE PROCEDURE
            Mes_Mrb_Sn_Confirm2(TWO IN VARCHAR2, TPALLET IN VARCHAR2,TTRANSFERTYPE IN VARCHAR2, TEMPID IN VARCHAR2, TRES OUT VARCHAR2) AS
C_ID 	VARCHAR2(25);
C_EDID VARCHAR2(25);
C_QTY	NUMBER;
C_DOC 	VARCHAR2(25);
C_ITEM_NO VARCHAR2(25);
C_SN	VARCHAR2(25);
C_ORIGIN_COUNTRY VARCHAR2(30);
--C_CUST_ITEM_NUMBER VARCHAR2(20);
C_SUBINV VARCHAR2(10);
C_CUSTPARTNO VARCHAR2(30);
C_ORGID SAJET.SYS_FACTORY.FACTORY_CODE%TYPE;
C_APPLICATION_SENDER_CODE VARCHAR2(15);
C_FROM_MANUFACTURING_LOCATION B2B.PT_ITEMS.FROM_MANUFACTURING_LOCATION%TYPE;


CURSOR sn_cursor IS
   SELECT SERIAL_NUMBER FROM SAJET.MES_TO_MRB_SN WHERE WORK_ORDER=TWO AND PALLET_NO = TPALLET AND MOVE_FLAG='N' ;

sn_record sn_cursor%ROWTYPE;

BEGIN

    C_QTY:=0;

    SELECT COUNT(*) INTO C_QTY  FROM SAJET.MES_TO_MRB_SN WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N';
    IF C_QTY=0 THEN
       TRES:='NOT FIND SN IN PALLET '||TPALLET;
       GOTO ENDP;
    END IF;
	
	SELECT NVL(SUBINV,0),NVL(CUST_PART_NO,0) INTO C_SUBINV, C_CUSTPARTNO FROM SAJET.MES_TO_MRB_SN 
	  WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N' AND ROWNUM=1;
	IF C_SUBINV='0' THEN
	   TRES:='WAREHOUSE IS ERROR(SUBINV)';
	   GOTO ENDP;
	END IF;
	IF C_CUSTPARTNO='0' THEN
	   TRES:='CUST_PART_NO DATA IS ERROR ';
       GOTO ENDP;
    END IF;
    
	C_ID:='XX';
	C_ITEM_NO:='XX';
    SELECT ITEM_ID, CHECK_CODE INTO C_ITEM_NO, C_ID  FROM SAJET.MES_TO_MRB_SN 
      WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N' AND ROWNUM=1;   


-- ***** EDI BEGIN *****
    C_APPLICATION_SENDER_CODE:='XXX';
	SELECT ORG_ID INTO C_ORGID  FROM SAJET.MES_TO_MRB_SN 
	   WHERE WORK_ORDER=TWO AND PALLET_NO = TPALLET AND ROWNUM=1;
	IF C_ORGID='85' THEN 
		   --C_APPLICATION_SENDER_CODE := 'FD1';
		 C_APPLICATION_SENDER_CODE :='657200226';   
	END IF;
	IF (C_ORGID='509') OR (C_ORGID='1437') THEN 
		   --C_APPLICATION_SENDER_CODE := 'H21';
		 C_APPLICATION_SENDER_CODE :='544976293';   
    END IF;
	
	--GET C_FROM_MANUFACTURING_LOCATION 
	IF C_SUBINV='Q02BBF/T' THEN
	   C_FROM_MANUFACTURING_LOCATION:='RAW2';
	ELSE 
	   C_FROM_MANUFACTURING_LOCATION:='RAW';
	END IF;
   
	SAJET.Mes_Edi_Get_Id('MB', C_DOC);

       C_EDID := SUBSTR(C_ID,5,9);

       INSERT INTO b2b.ENVELOPE
             (DOC_ID, SENDER_ID, RECEIVER_ID, DIRECTION, B2B_MSG_TYPE, DATASOURCE, DOC_DATETIME, TRANS_FLAG, SEQ_ID)
       VALUES (C_DOC, '657200226', '098533326', 'OUT', '867', 'EDI', SYSDATE, 'M', C_EDID);

        INSERT INTO b2b.PT_HEADER
              (DOC_ID, SENDER_ID, RECEIVER_ID, INVENTORY_BATCH_ID, FINISH_DATE, SYSTEM_DATE, SEQ_ID, 
			     INVENTORY_LOCATION_NAME, APPLICATION_SENDER_CODE)
        VALUES (C_DOC, '657200226', '098533326', TPALLET, SYSDATE, SYSDATE, C_EDID,
		         C_SUBINV, C_APPLICATION_SENDER_CODE);

	   /*INSERT INTO b2b.PT_ITEMS
              (DOC_ID, WORK_ORDER_NUMBER, TRANSFER_QUANTITY,ROW_ITEM_NUMBER, FG_ITEM_NUMBER, SEQ_ID,Transfer_Type_Code,
			    CUST_RAW_PART_NUMBER,CUST_KIT_PART_NUMBER,FROM_MANUFACTURING_LOCATION,TO_MANUFACTURING_LOCATION )
          VALUES (C_DOC, TWO, C_QTY,C_ITEM_NO, C_ITEM_NO, C_EDID, TTRANSFERTYPE,
		        C_CUSTPARTNO,C_CUSTPARTNO,'RAW','MRB'); 
	    */
       INSERT INTO b2b.PT_ITEMS
              (DOC_ID, WORK_ORDER_NUMBER, TRANSFER_QUANTITY,ROW_ITEM_NUMBER, FG_ITEM_NUMBER, SEQ_ID,Transfer_Type_Code,
			    CUST_RAW_PART_NUMBER,CUST_KIT_PART_NUMBER,FROM_MANUFACTURING_LOCATION,TO_MANUFACTURING_LOCATION )
          VALUES (C_DOC, TWO, C_QTY,C_ITEM_NO, C_ITEM_NO, C_EDID, TTRANSFERTYPE,
		        C_CUSTPARTNO,C_CUSTPARTNO,C_FROM_MANUFACTURING_LOCATION,'MRB'); 
		
       C_ORIGIN_COUNTRY := 'XXX';
	   FOR sn_record IN sn_cursor LOOP
           C_SN := sn_record.SERIAL_NUMBER;
		     
		   IF  SUBSTR(C_SN, 1, 1) = '5' THEN C_ORIGIN_COUNTRY := 'CN'; 
		   ELSIF SUBSTR(C_SN, 1, 1) = '6' THEN C_ORIGIN_COUNTRY := 'CN';
		   ELSIF SUBSTR(C_SN, 1, 1) = '4' THEN C_ORIGIN_COUNTRY := 'TH';
		   ELSIF SUBSTR(C_SN, 1, 1) = '9' THEN C_ORIGIN_COUNTRY := 'TH';
		   ELSIF SUBSTR(C_SN, 1, 1) = '3' THEN C_ORIGIN_COUNTRY := 'SG'; 
		   ELSIF SUBSTR(C_SN, 1, 1) = 'L' THEN C_ORIGIN_COUNTRY := 'SG';
		   ELSIF SUBSTR(C_SN, 1, 1) = 'Q' THEN C_ORIGIN_COUNTRY := 'SG'; 
		   ELSIF SUBSTR(C_SN, 1, 1) = '1' THEN C_ORIGIN_COUNTRY := 'US';
		   ELSIF SUBSTR(C_SN, 1, 1) = 'B' THEN C_ORIGIN_COUNTRY := 'US'; 
		   ELSIF SUBSTR(C_SN, 1, 1) = 'H' THEN C_ORIGIN_COUNTRY := 'US'; 
		   END IF;
		   
           INSERT INTO b2b.PT_SERIAL
                  (DOC_ID, SERIAL_NUMBER, WORK_ORDER_NUMBER, FIRMWARE_VERSION, SEQ_ID,ORIGIN_COUNTRY,ASSEMBLY_QUANTITY)
           VALUES (C_DOC, C_SN, TWO, 'N/A', C_EDID,C_ORIGIN_COUNTRY,'1');

        END LOOP;
  

-- ***** EDI END *****
     -- 方便資料MOVE TO HT TEMP TABLE 
     UPDATE SAJET.MES_TO_MRB_SN SET QTY=C_QTY, MOVE_FLAG='Y', USER_ID=TEMPID WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N';
     
	 COMMIT;

     TRES := 'MRB CONFIRM OK';

<<ENDP>>
   NULL;
EXCEPTION
   WHEN OTHERS THEN
      ROLLBACK;
      TRES := 'MES_MRB_SN_CONFIRM ERROR';
END;
/
