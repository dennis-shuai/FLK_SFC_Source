CREATE OR REPLACE PROCEDURE
         MES_ORT_SN_INPUT(TORGID IN VARCHAR2,TSUBINV IN VARCHAR2, TLOCATOR IN VARCHAR2,
		 TTYPE IN VARCHAR2,TPARTNO IN VARCHAR2, TWO IN VARCHAR2,TPALLET IN VARCHAR2,
		 TSN IN VARCHAR2, TEMPID IN VARCHAR2,THDDQTY IN VARCHAR2, TRES OUT VARCHAR2) AS
C_ID 	VARCHAR2(25);
CCOUNT	NUMBER;
C_ITEMID VARCHAR2(25);
C_SITEMID VARCHAR2(25);
C_MOVEFLAG VARCHAR2(1);
C_ORGID  VARCHAR2(10);
C_SUBINV  SAJET.SYS_WAREHOUSE.WAREHOUSE_NAME%TYPE;
C_LOCATOR SAJET.SYS_LOCATE.LOCATE_NAME%TYPE;
C_EDA_NEW_ITEM VARCHAR2(25);
C_EDA_OLD_ITEM VARCHAR2(25);
BEGIN
--ONE WO ONLEY HAS ONE PALLET 
    --CHECK ORGID 
   /* IF (TORGID<>'85')  AND (TORGID<>'509') AND (TORGID<>'1437') THEN
	   TRES:='SELECT ORG ERR!';
	   GOTO ENDP;
	END IF;
	--CHECK STOCK 
	IF  (TSUBINV<>'W1B') and (TSUBINV<>'Q0BB/T') and (TSUBINV<>'Q0BBF/T') and (TSUBINV<>'Q02BBF/T') THEN
	   TRES:='SELECT STOCK ERR!';
	   GOTO ENDP;
	END IF;
	-- CHECK ORG AND STOCK COMPARE 
	IF TORGID='85' THEN
	  IF TSUBINV<>'W1B' THEN
	     TRES:='ORG AND STOCK IS ERROR!';
	     GOTO ENDP;
	  END IF;
	END IF;
    IF TORGID='509' THEN
	   IF TSUBINV<>'Q0BB/T' THEN
	      TRES:='ORG AND STOCK IS ERROR!';
	      GOTO ENDP;
	   END IF;
	END IF;
	IF TORGID='1437' THEN
	   IF (TSUBINV<>'Q0BBF/T') and (TSUBINV<>'Q02BBF/T')  THEN
	      TRES:='ORG AND STOCK IS ERROR!';
	      GOTO ENDP;
	   END IF;
	END IF;
	
	*/
    SELECT a.OPTION7 INTO C_EDA_NEW_ITEM FROM sajet.G_SN_STATUS b, sajet.SYS_PART a
         WHERE b.SERIAL_NUMBER=TSN AND b.MODEL_ID = a.PART_ID AND ROWNUM = 1;
	--check locate 
	BEGIN
	    SELECT ORG_ID,SUBINV,LOCATOR,EDA_ITEM
		     INTO C_ORGID,C_SUBINV,C_LOCATOR,C_EDA_OLD_ITEM  FROM SAJET.MES_TO_ORT_SN 
		WHERE WORK_ORDER=TWO AND ROWNUM=1;
		IF TORGID<>C_ORGID THEN
		    TRES:='SELECT ORG ERR!';
			GOTO ENDP;
		END IF;
		IF TSUBINV<>C_SUBINV THEN
		    TRES:='SELECT STOCK ERR!';
			GOTO ENDP;
		END IF;
		IF TLOCATOR<>C_LOCATOR THEN
		   TRES:='SELECT LOCATOR ERR!';
		   GOTO ENDP;
		END IF;
		IF C_EDA_NEW_ITEM<>C_EDA_OLD_ITEM THEN
		   TRES:='PART_NO Different!';
		   GOTO ENDP;
		END IF;
	EXCEPTION
	   WHEN OTHERS THEN
	     tres:='OK';
	END;
	
   --CHECK SN 
    SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_TO_ORT_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
       TRES :='SN DUB';
       GOTO ENDP; 
    END IF;
	
	SELECT COUNT(*) INTO CCOUNT  FROM SAJET.MES_HT_TO_ORT_SN WHERE SERIAL_NUMBER=TSN;
    IF CCOUNT>0 THEN
      TRES :='SN DUB';
      GOTO ENDP; 
    END IF;
	
   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_TO_ORT_SN WHERE work_order=TWO AND MOVE_FLAG='Y' ;
   IF CCOUNT>0 THEN 
      TRES:= TWO||' IS CLOSED(ORT_NO)';
	  GOTO ENDP;
   END IF;
	
   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_HT_TO_ORT_SN WHERE work_order=TWO AND ROWNUM=1 ;
   IF CCOUNT>0 THEN 
      TRES:= TWO||' IS CLOSED(ORT_NO)';
	  GOTO ENDP;
   END IF;

   SELECT COUNT(*) INTO CCOUNT FROM SAJET.MES_TO_ORT_SN WHERE work_order=TWO ;

   C_ID := 'XX';
   IF CCOUNT = 0 THEN
     SAJET.Mes_Push_Title_Get_Id('RT', C_ID);  --MRB 
   END IF;
   IF CCOUNT > 0 THEN
      SELECT MOVE_FLAG INTO C_MOVEFLAG FROM SAJET.MES_TO_ORT_SN WHERE work_order=TWO AND ROWNUM=1;
	  IF C_MOVEFLAG='Y' THEN
		 TRES:=TPALLET||' IS CLOSED(PALLET)';
		 GOTO ENDP;
	  ELSE 
	     SELECT CHECK_CODE INTO C_ID FROM  SAJET.MES_TO_ORT_SN WHERE WORK_ORDER=TWO AND  MOVE_FLAG='N' AND ROWNUM=1;      
	  END IF;
   END IF;
   IF C_ID = 'XX' THEN
        TRES := 'TTYPE ERROR ('||TTYPE||')'; 
        GOTO ENDP;
     ELSE
	   INSERT INTO SAJET.MES_TO_ORT_SN
                    (work_order,subinv,LOCATOR, pallet_no,serial_number,create_time, to_erp, move_flag, 
					   check_code, user_id, seq_id, org_id, HDDSN_QTY,EDA_ITEM)
             VALUES (TWO,TSUBINV,TLOCATOR, TPALLET, TSN, SYSDATE, 'N', 'N', 
			           C_ID, TEMPID, C_ID,TORGID,THDDQTY,C_EDA_NEW_ITEM);
       COMMIT;

       TRES := 'OK';
   END IF;
<<ENDP>>
  NULL;
EXCEPTION
   WHEN OTHERS THEN
      ROLLBACK;
      TRES := 'MES_ORT_SN_INPUT ERROR';
END;
/
