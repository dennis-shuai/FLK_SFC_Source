CREATE OR REPLACE PROCEDURE
Mes_ORT_Sn_Confirm(TWO IN VARCHAR2, TPALLET IN VARCHAR2,TTRANSFERTYPE IN VARCHAR2, TEMPID IN VARCHAR2, TRES OUT VARCHAR2) AS
C_ID 	VARCHAR2(25);
C_EDID VARCHAR2(25);
C_QTY	NUMBER;
C_DOC 	VARCHAR2(25);
C_ITEM_NO VARCHAR2(25);
C_SN	VARCHAR2(25);
C_SUBINV VARCHAR2(10);
C_CUSTPARTNO VARCHAR2(30);
C_ORGID SAJET.SYS_FACTORY.FACTORY_CODE%TYPE;
C_APPLICATION_SENDER_CODE VARCHAR2(15);
C_ROW_ITEM  VARCHAR2(25);

CURSOR sn_cursor IS
   SELECT SERIAL_NUMBER,HDDSN_QTY FROM SAJET.MES_TO_ORT_SN WHERE WORK_ORDER=TWO AND PALLET_NO = TPALLET AND MOVE_FLAG='N' ;

sn_record sn_cursor%ROWTYPE;
BEGIN
    C_QTY:=0;

    SELECT COUNT(*) INTO C_QTY  FROM SAJET.MES_TO_ORT_SN WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N';
    IF C_QTY=0 THEN
       TRES:='NOT FIND SN IN PALLET '||TPALLET;
       GOTO ENDP;
    END IF;
	
	SELECT NVL(SUBINV,0) INTO C_SUBINV FROM SAJET.MES_TO_ORT_SN 
	  WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N' AND ROWNUM=1;
	IF C_SUBINV='0' THEN
	   TRES:='WAREHOUSE IS ERROR(SUBINV)';
	   GOTO ENDP;
	END IF;
    
	C_ID:='XX';
    SELECT CHECK_CODE,EDA_ITEM INTO  C_ID, C_ROW_ITEM  FROM SAJET.MES_TO_ORT_SN 
      WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N' AND ROWNUM=1;   


-- ***** EDI BEGIN *****
    C_APPLICATION_SENDER_CODE:='XXX';
	SELECT ORG_ID INTO C_ORGID  FROM SAJET.MES_TO_ORT_SN 
	   WHERE WORK_ORDER=TWO AND PALLET_NO = TPALLET AND ROWNUM=1;
	IF C_ORGID='85' THEN 
		   --C_APPLICATION_SENDER_CODE := 'FD1';
		 C_APPLICATION_SENDER_CODE :='657200226';   
	END IF;
	IF (C_ORGID='509') OR (C_ORGID='1437') THEN 
		   --C_APPLICATION_SENDER_CODE := 'H21';
		 C_APPLICATION_SENDER_CODE :='544976293';   
    END IF;
   
	SAJET.Mes_Edi_Get_Id('RT', C_DOC);

       C_EDID := SUBSTR(C_ID,5,9);

       INSERT INTO b2b.ENVELOPE
             (DOC_ID, SENDER_ID, RECEIVER_ID, DIRECTION, B2B_MSG_TYPE, DATASOURCE, DOC_DATETIME, TRANS_FLAG, SEQ_ID)
       VALUES (C_DOC, '657200226', '098533326', 'OUT', '867', 'EDI', SYSDATE, 'M', C_EDID);

       INSERT INTO b2b.PT_HEADER
              (DOC_ID, SENDER_ID, RECEIVER_ID, INVENTORY_BATCH_ID, FINISH_DATE, SYSTEM_DATE, SEQ_ID, 
			     INVENTORY_LOCATION_NAME, APPLICATION_SENDER_CODE)
       VALUES (C_DOC, '657200226', '098533326', TPALLET, SYSDATE, SYSDATE, C_EDID,
		         C_SUBINV, C_APPLICATION_SENDER_CODE);

       INSERT INTO b2b.PT_ITEMS
              (DOC_ID, WORK_ORDER_NUMBER, TRANSFER_QUANTITY,ROW_ITEM_NUMBER, FG_ITEM_NUMBER, SEQ_ID,Transfer_Type_Code,
			    CUST_RAW_PART_NUMBER,CUST_KIT_PART_NUMBER,FROM_MANUFACTURING_LOCATION,TO_MANUFACTURING_LOCATION )
       VALUES (C_DOC, TWO, C_QTY,C_ROW_ITEM, C_ITEM_NO, C_EDID, TTRANSFERTYPE,
		        C_CUSTPARTNO,C_CUSTPARTNO,'ORT','RAW'); 
		
       FOR sn_record IN sn_cursor LOOP
           C_SN := sn_record.SERIAL_NUMBER;   
           INSERT INTO b2b.PT_SERIAL
                  (DOC_ID, SERIAL_NUMBER, WORK_ORDER_NUMBER, FIRMWARE_VERSION, SEQ_ID,ASSEMBLY_QUANTITY,TYPE)
           VALUES (C_DOC, C_SN, TWO, 'N/A', C_EDID,sn_record.HDDSN_QTY,'ORT867');
       END LOOP;
  

-- ***** EDI END *****
     -- ¿¿¿¿MOVE TO HT TEMP TABLE 
     UPDATE SAJET.MES_TO_ORT_SN SET QTY=C_QTY, MOVE_FLAG='Y', USER_ID=TEMPID WHERE WORK_ORDER=TWO AND  PALLET_NO = TPALLET AND MOVE_FLAG='N';
     
	 COMMIT;

     TRES := 'ORT CONFIRM OK';

<<ENDP>>
   NULL;
EXCEPTION
   WHEN OTHERS THEN
      ROLLBACK;
      TRES := 'MES_ORT_SN_CONFIRM ERROR';
END;
/
