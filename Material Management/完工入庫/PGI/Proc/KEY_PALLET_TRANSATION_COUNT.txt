CREATE OR REPLACE PROCEDURE SAJET.KEY_PALLET_TRANSATION_COUNT (
   TLINEID IN NUMBER,
   TSTAGEID IN NUMBER,
   TPROCESSID IN NUMBER,
   TEMP IN NUMBER,
   TNOW IN DATE,
   TPALLET IN VARCHAR2,
   PWO IN VARCHAR2,
   PMODELID IN NUMBER,
   PPASS IN NUMBER,
   PFAIL IN NUMBER,
   TRES OUT VARCHAR2)
IS
   CWORKDATE VARCHAR2(8);
   CWORKTIME NUMBER;
   CREWORK NUMBER;
   CROWID VARCHAR2(25);
   CSHIFTID NUMBER;
   COUTPUTQTY NUMBER;
   CSN SAJET.G_SN_STATUS.SERIAL_NUMBER%TYPE;
BEGIN
   CWORKDATE := TO_CHAR(TNOW, 'YYYYMMDD');
   CWORKTIME := SAJET.SJ_GET_TIME_SECTION(TNOW);

   SAJET.SJ_GET_PDLINE_SHIFT(TLINEID, CSHIFTID);

   BEGIN
      SELECT ROWID INTO CROWID FROM SAJET.G_SN_TRAVEL
       WHERE WORK_ORDER = PWO AND PALLET_NO = TPALLET
         AND PROCESS_ID = TPROCESSID AND ROWNUM = 1;
      CREWORK := 1;
   EXCEPTION
      WHEN OTHERS THEN
         CREWORK := 0;
   END;

   BEGIN
      SELECT ROWID INTO CROWID FROM SAJET.G_SN_COUNT
       WHERE PDLINE_ID = TLINEID AND STAGE_ID = TSTAGEID AND PROCESS_ID = TPROCESSID
         AND SHIFT_ID = CSHIFTID AND WORK_ORDER = PWO AND MODEL_ID = PMODELID
         AND WORK_DATE = CWORKDATE AND WORK_TIME = CWORKTIME AND ROWNUM = 1;
   EXCEPTION
      WHEN OTHERS THEN
         CROWID := '0';
   END;

   IF PFAIL = 0 THEN
      COUTPUTQTY := PPASS;
   ELSE
      COUTPUTQTY := 0;
   END IF;

   IF CREWORK = 0 THEN
      IF CROWID = '0' THEN
         INSERT INTO SAJET.G_SN_COUNT
         (WORK_ORDER, MODEL_ID, PDLINE_ID, STAGE_ID, PROCESS_ID, SHIFT_ID,
          WORK_DATE, WORK_TIME, PASS_QTY, FAIL_QTY, REPASS_QTY, REFAIL_QTY, OUTPUT_QTY) VALUES
         (PWO, PMODELID, TLINEID, TSTAGEID, TPROCESSID, CSHIFTID, CWORKDATE, CWORKTIME, PPASS, PFAIL, 0, 0, COUTPUTQTY);
      ELSE
         UPDATE SAJET.G_SN_COUNT
            SET PASS_QTY = PASS_QTY + PPASS, FAIL_QTY = FAIL_QTY + PFAIL, OUTPUT_QTY = OUTPUT_QTY + COUTPUTQTY
          WHERE ROWID = CROWID;
      END IF;
   ELSE
      IF CROWID = '0' THEN
         INSERT INTO SAJET.G_SN_COUNT
         (WORK_ORDER, MODEL_ID, PDLINE_ID, STAGE_ID, PROCESS_ID, SHIFT_ID,
          WORK_DATE, WORK_TIME, PASS_QTY, FAIL_QTY, REPASS_QTY, REFAIL_QTY, OUTPUT_QTY) VALUES
         (PWO, PMODELID, TLINEID, TSTAGEID, TPROCESSID, CSHIFTID, CWORKDATE, CWORKTIME, 0, 0, PPASS, PFAIL, COUTPUTQTY);
      ELSE
         UPDATE SAJET.G_SN_COUNT
            SET REPASS_QTY = REPASS_QTY + PPASS, REFAIL_QTY = REFAIL_QTY + PFAIL, OUTPUT_QTY = OUTPUT_QTY + COUTPUTQTY
          WHERE ROWID = CROWID;
      END IF;
   END IF;

   TRES := 'OK';
EXCEPTION
   WHEN OTHERS THEN
      TRES := 'KEY_PALLET_TRANSATION_COUNT ERROR ' || CSHIFTID;
END;
