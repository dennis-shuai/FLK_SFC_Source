CREATE OR REPLACE PROCEDURE SAJET.KEY_PALLET_WO_INPUT (
   TPROCESSID IN NUMBER,
   TSN IN VARCHAR2,
   TNOW IN DATE,
   TRES OUT VARCHAR2,
   CEMPID IN VARCHAR2,
   CQTY IN NUMBER,
   BFLAG OUT BOOLEAN)
IS
   CSTARTP NUMBER;
   CINPDLINE DATE;
   COUTPDLINE DATE;
   CENDP NUMBER;
   CWO VARCHAR2(25);
   CSTATUS VARCHAR2(1);
BEGIN
   BFLAG := FALSE;

   SELECT B.WORK_ORDER, START_PROCESS_ID, END_PROCESS_ID, WO_STATUS, IN_PDLINE_TIME, OUT_PDLINE_TIME
          INTO CWO, CSTARTP, CENDP, CSTATUS, CINPDLINE, COUTPDLINE
     FROM SAJET.G_WO_BASE A, SAJET.G_SN_STATUS B
    WHERE B.SERIAL_NUMBER = TSN
      AND A.WORK_ORDER = B.WORK_ORDER
      AND ROWNUM = 1;

   IF (CSTARTP = TPROCESSID) AND (CINPDLINE IS NULL) THEN
      BFLAG := TRUE;

      IF CSTATUS = '2' THEN
         UPDATE SAJET.G_WO_BASE
            SET INPUT_QTY = INPUT_QTY + CQTY, WO_STATUS = '3', WO_START_DATE = TNOW,
                   UPDATE_TIME = SYSDATE, UPDATE_USERID = CEMPID
          WHERE WORK_ORDER = CWO
            AND ROWNUM = 1;

         INSERT INTO SAJET.G_HT_WO_BASE
         SELECT * FROM SAJET.G_WO_BASE WHERE WORK_ORDER = CWO AND ROWNUM = 1;
      ELSE
         UPDATE SAJET.G_WO_BASE SET INPUT_QTY = INPUT_QTY + CQTY
          WHERE WORK_ORDER = CWO AND ROWNUM = 1;
      END IF;
   END IF;

   TRES := 'OK';
EXCEPTION
   WHEN OTHERS THEN
      TRES := 'KEY_PALLET_WO_INPUT ERROR';
END;
