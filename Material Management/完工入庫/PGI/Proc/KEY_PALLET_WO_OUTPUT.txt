CREATE OR REPLACE PROCEDURE SAJET.KEY_PALLET_WO_OUTPUT (
   TPROCESSID IN NUMBER,
   TSN IN VARCHAR2,
   TNOW IN DATE,
   TRES OUT VARCHAR2,
   CEMPID IN VARCHAR2,
   CQTY IN NUMBER,
   BFLAG OUT BOOLEAN)
IS
   CSTARTP NUMBER;
   CINPDLINE DATE;
   COUTPDLINE DATE;
   CENDP NUMBER;
   CWO VARCHAR2(25);
   CSTATUS VARCHAR2(1);
   CTARGET NUMBER;
   COUTPUT NUMBER;
   CSCRAP NUMBER;
BEGIN
   BFLAG := FALSE;

   SELECT B.WORK_ORDER, START_PROCESS_ID, END_PROCESS_ID,
          WO_STATUS, TARGET_QTY, OUTPUT_QTY, IN_PDLINE_TIME, OUT_PDLINE_TIME
     INTO CWO, CSTARTP, CENDP, CSTATUS, CTARGET, COUTPUT, CINPDLINE, COUTPDLINE
     FROM SAJET.G_WO_BASE A, SAJET.G_SN_STATUS B
    WHERE B.SERIAL_NUMBER = TSN
      AND A.WORK_ORDER = B.WORK_ORDER
      AND ROWNUM = 1;

   IF (CENDP = TPROCESSID) AND (COUTPDLINE IS NULL) THEN
      BFLAG := TRUE;

      SELECT NVL(COUNT(*), 0) INTO CSCRAP FROM SAJET.G_SN_STATUS
       WHERE WORK_ORDER = CWO
         AND WORK_FLAG <> '0';

      IF COUTPUT + CSCRAP + CQTY >= CTARGET THEN
         UPDATE SAJET.G_WO_BASE
            SET OUTPUT_QTY = OUTPUT_QTY + CQTY, WO_STATUS = '6', WO_CLOSE_DATE = SYSDATE,
                UPDATE_TIME = SYSDATE, UPDATE_USERID = CEMPID
          WHERE WORK_ORDER = CWO;

         INSERT INTO SAJET.G_HT_WO_BASE
         SELECT * FROM SAJET.G_WO_BASE WHERE WORK_ORDER = CWO;
      ELSE
         UPDATE SAJET.G_WO_BASE SET OUTPUT_QTY = OUTPUT_QTY + CQTY WHERE WORK_ORDER = CWO;
      END IF;
   END IF;

   TRES := 'OK';
EXCEPTION
   WHEN OTHERS THEN
      TRES := 'KEY_PALLET_WO_OUTPUT ERROR';
END;
